#!/bin/bash

# Exit script on error
set -e

# Define the installation directory
INSTALL_DIR="$HOME/opencti"

# Install dependencies
echo "Installing dependencies..."
sudo apt update
sudo apt install -y git jq docker.io docker-compose

# Clone the OpenCTI Docker repository
echo "Cloning the OpenCTI Docker repository..."
mkdir -p "$INSTALL_DIR" && cd "$INSTALL_DIR"
git clone https://github.com/OpenCTI-Platform/docker.git
cd docker

# Generate .env file with default values
echo "Generating .env file..."
(cat << EOF
OPENCTI_ADMIN_EMAIL=admin@opencti.io
OPENCTI_ADMIN_PASSWORD=ChangeMePlease
OPENCTI_ADMIN_TOKEN=$(cat /proc/sys/kernel/random/uuid)
OPENCTI_BASE_URL=http://localhost:8080
MINIO_ROOT_USER=$(cat /proc/sys/kernel/random/uuid)
MINIO_ROOT_PASSWORD=$(cat /proc/sys/kernel/random/uuid)
RABBITMQ_DEFAULT_USER=guest
RABBITMQ_DEFAULT_PASS=guest
ELASTIC_MEMORY_SIZE=4G
CONNECTOR_HISTORY_ID=$(cat /proc/sys/kernel/random/uuid)
CONNECTOR_EXPORT_FILE_STIX_ID=$(cat /proc/sys/kernel/random/uuid)
CONNECTOR_EXPORT_FILE_CSV_ID=$(cat /proc/sys/kernel/random/uuid)
CONNECTOR_IMPORT_FILE_STIX_ID=$(cat /proc/sys/kernel/random/uuid)
CONNECTOR_EXPORT_FILE_TXT_ID=$(cat /proc/sys/kernel/random/uuid)
CONNECTOR_IMPORT_DOCUMENT_ID=$(cat /proc/sys/kernel/random/uuid)
SMTP_HOSTNAME=localhost
EOF
) > .env

# Configure ElasticSearch system parameter
echo "Configuring system parameters for ElasticSearch..."
sudo sysctl -w vm.max_map_count=1048575
if ! grep -q "vm.max_map_count" /etc/sysctl.conf; then
  echo "vm.max_map_count=1048575" | sudo tee -a /etc/sysctl.conf
fi

# Start Docker service
echo "Starting Docker service..."
sudo systemctl start docker.service

# Run Docker Compose
echo "Starting OpenCTI containers..."
docker-compose up -d

# For Docker Swarm (optional)
echo "Setting up Docker Swarm (optional)..."
docker swarm init || true
sudo bash -c 'cat .env >> /etc/environment'
sudo docker stack deploy --compose-file docker-compose.yml opencti

echo "OpenCTI setup completed successfully!"
