#!/bin/bash

# Update package list and install dependencies
echo "Updating package list and installing dependencies..."
sudo apt-get update
sudo apt-get install -y build-essential nodejs npm python3 python3-pip python3-dev wget git tar

# Define installation path
INSTALL_DIR="/opt/opencti"  # Change this to your preferred installation path

# Create installation directory
echo "Creating installation directory at $INSTALL_DIR..."
mkdir -p "$INSTALL_DIR"
cd "$INSTALL_DIR"

# Clone the OpenCTI repository from GitHub
echo "Cloning OpenCTI repository..."
git clone https://github.com/OpenCTI-Platform/opencti.git

# Change to the OpenCTI directory
cd opencti

# Checkout the desired release version (Optional)
RELEASE_VERSION="5.9.1"  # Replace with the desired release version or branch
echo "Checking out release version $RELEASE_VERSION..."
git checkout "v$RELEASE_VERSION"

# Configure the main application
echo "Configuring OpenCTI main application..."
cp config/default.json config/production.json
echo "Please edit config/production.json to configure ElasticSearch, Redis, RabbitMQ, S3, and set the ADMIN_TOKEN as a valid UUID."

# Install Python dependencies for the main application
echo "Installing Python dependencies for OpenCTI..."
cd src/python
pip3 install -r requirements.txt
cd ../..

# Check and install the required versions of yarn and Node.js
echo "Checking Node.js and Yarn versions..."
NODE_VERSION=$(node --version)
YARN_VERSION=$(yarn --version || echo "not installed")

if [[ "$NODE_VERSION" < "v19" || "$YARN_VERSION" < "4" ]]; then
  echo "Please update Node.js to v19+ and Yarn to v4+ if not already installed."
  exit 1
fi

# Build and run the main platform
echo "Building and starting OpenCTI main platform..."
yarn install
yarn build
yarn serv &  # Run in the background

# Install and configure the worker
echo "Installing and configuring the worker..."
cd worker
pip3 install -r requirements.txt
cp config.yml.sample config.yml
echo "Please edit worker/config.yml to set your OpenCTI token."

# Start multiple worker processes
echo "Starting OpenCTI workers..."
python3 worker.py &  # Start first worker
python3 worker.py &  # Start additional worker if needed

echo "Installation and setup complete. OpenCTI is now running."
